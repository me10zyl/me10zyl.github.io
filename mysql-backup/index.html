<!DOCTYPE html>
<html lang="zh-cn,zh-Hans,en,default">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="MySQL 数据库基于LVM快照热备份">




  <meta name="keywords" content="mysql,">




  <link rel="alternate" href="/atom.xml" title="Rainy Mood - allyn 的日志">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.4.x">



<link rel="canonical" href="http://www.yilnz.com/mysql-backup/">


<meta name="description" content="MySQL 数据库的热备份 - 基于LVM快照备份。">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL 数据库基于LVM快照热备份">
<meta property="og:url" content="http://www.yilnz.com/mysql-backup/index.html">
<meta property="og:site_name" content="Rainy Mood - allyn 的日志">
<meta property="og:description" content="MySQL 数据库的热备份 - 基于LVM快照备份。">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2018-10-12T01:19:04.375Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL 数据库基于LVM快照热备份">
<meta name="twitter:description" content="MySQL 数据库的热备份 - 基于LVM快照备份。">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">





<script>
  var CONFIG = {
    search: true,
    searchPath: "/search.xml",
    fancybox: true,
    toc: true,
  }
</script>




  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5d142d59d006582dbacd580c9eb430f5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>





  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<!--
<script type="text/javascript" async
  src="/js/src/mathjax-2.7.1.js">
</script>-->



    <title> MySQL 数据库基于LVM快照热备份 · Rainy Mood - allyn 的日志 </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Rainy Mood - allyn 的日志</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/books">
        <li class="mobile-menu-item">
          
          
            Books
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/essays">
        <li class="mobile-menu-item">
          
          
            Essay
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    
    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">

  <!-- <a href="/essays" class="logo">Rainy Mood - allyn 的日志</a> -->

  <a href="/." class="logo">Rainy Mood - allyn 的日志</a>

</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/books">
            
            
              书籍
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/essays">
            
            
              随笔
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
      
        <li class="menu-search">
          <form>
            <i class="iconfont icon-search" id="open-search"></i>
            <input type="text" class="search-input" id="search-input">
            <i class="iconfont icon-close" id="close-search"></i>
          </form>
        </li>
      
    </ul>
  
</nav>

<nav style="clear:left">
	<a href="/"> 首页 </a> &gt <a href="http://www.yilnz.com/mysql-backup/">mysql-backup</a>
</nav>

      </header>


      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          MySQL 数据库基于LVM快照热备份
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月16日
	</span>
        
          <div class="post-tags" style="display:inline-block">
            
              <a href="/tags/mysql/">#mysql</a>
            
          </div>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#热备与冷备"><span class="toc-text">热备与冷备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-复制备份"><span class="toc-text">1. 复制备份</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-快照备份"><span class="toc-text">2. 快照备份</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-开始备份"><span class="toc-text">3. 开始备份</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-准备工作"><span class="toc-text">1.准备工作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-启用数据库二进制日志"><span class="toc-text">2.启用数据库二进制日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-更改数据库-server-id"><span class="toc-text">2.更改数据库 server-id</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-配置主从数据库"><span class="toc-text">3.配置主从数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-自动创建快照"><span class="toc-text">4.自动创建快照</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#4-小结"><span class="toc-text">4.小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-text">参考资料</span></a></li>
    </div>
  </div>


    <div class="post-content">
      
        <p>MySQL 数据库的热备份 - 基于LVM快照备份。</p>
<a id="more"></a>
<h2 id="热备与冷备"><a href="#热备与冷备" class="headerlink" title="热备与冷备"></a>热备与冷备</h2><p>数据库的备份与恢复是一项最基本但是却不简单的工作，根据不同类型来划分备份的方法，划分出最基础的两种备份，热备与冷备。冷备是指在数据库停止的情况下，一般只需要复制相关数据库文件，而热备即在数据库运行的时候直接备份，对正在运行的数据库没有任何影响。 </p>
<p>以下通过两种备份来保证数据的安全，复制备份与快照备份。复制备份用于数据库实时备份，当开发人员对主数据库进行误操作时，其结果也会应用到从数据库，所以需要对从数据库进行快照(snapshot)来防止从数据库数据丢失。</p>
<h2 id="1-复制备份"><a href="#1-复制备份" class="headerlink" title="1. 复制备份"></a>1. 复制备份</h2><p>同大多数关系型数据库一样，日志文件是MySQL数据库的重要组成部分。MySQL有几种不同的日志文件，通常包括错误日志文件，二进制日志，通用日志，慢查询日志，等等。这些日志可以帮助我们定位mysqld内部发生的事件，数据库性能故障，记录数据的变更历史，用户恢复数据库等等。  </p>
<p>其中二进制日志可用于MySQL数据库的备份，通过一个完全备份进行二进制日志的重做来完成数据库的point-in-time的恢复工作，MySQL数据库复制(replication)的原理就是异步实时地将二进制日志重做传送并应用到从数据库。</p>
<p>MySQL 复制是MySQL数据库提供的一种高可用高性能的解决方案，复制的原理并不难，其实就是一个完全备份加上二进制日志备份的还原。</p>
<h2 id="2-快照备份"><a href="#2-快照备份" class="headerlink" title="2. 快照备份"></a>2. 快照备份</h2><p><code>Logical Volume Manager (LVM)</code>提供了对任意一个<code>Logical Volume(LV)</code>做“快照”(snapshot)的功能，以此来获得一个分区的状态一致性备份。<br>在某一个状态下做备份的时候，可能有应用正在访问某一个文件或者数据库，这就是使得备份的时候文件处于一个状态，而备份完后，文件却处于另外一个状态，从而造成备份的非一致性，这种状态恢复数据库数据几乎不会成功。</p>
<p>状态的解决办法是将其分区挂载为只读，然后通过数据库的表级别锁定(table-level write locks)甚至停止数据库来备份数据。所有这些方法无意严重影响了服务的可用性。使用LVM snapshot既可以获得一致性备份，又不会影响服务器的可用性。</p>
<h2 id="3-开始备份"><a href="#3-开始备份" class="headerlink" title="3. 开始备份"></a>3. 开始备份</h2><h4 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h4><p>有两台服务器<code>192.168.2.5</code>与<code>192.168.2.230</code>，在同一局域网，为了快速部署并且不影响操作系统，将使用<code>docker</code>作为运行<code>mysql</code>的容器。<br>从<code>docker hub</code>拉取或者自己制作一个镜像，这里已经在<code>192.168.2.5</code>制作好了一个镜像，并已经push到了<code>192.168.2.230</code>。</p>
<p>开始在<code>192.168.2.5</code> <strong>运行MySQL</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -h mysql-server --restart=always --name=mysql_server -p 3306:3306 -v /mnt1/data/mysql:/mnt/data/mysql-online 192.168.2.230:5000/sunyuki/mysqllinux:latest</span><br></pre></td></tr></table></figure>
<p>这样会运行一个<code>docker</code>容器，并且将<code>docker</code>中的<code>mysql</code>数据库文件<code>mnt/data/mysql-online</code>挂载到了本地磁盘<code>/mnt1/data/mysql</code>。</p>
<p>同样的，在<code>192.168.2.230</code>执行相同的命令，这样在两台机器的运行的<code>mysql</code>是一样的，并且两个容器的名称是<code>mysql_server</code>。</p>
<h4 id="2-启用数据库二进制日志"><a href="#2-启用数据库二进制日志" class="headerlink" title="2.启用数据库二进制日志"></a>2.启用数据库二进制日志</h4><p>因为复制的原理是重做二进制日志，所以需要为两台机器都启用二进制日志。</p>
<p>两台机器都运行起<code>docker</code>容器后，连接到<code>192.168.2.5</code>进入<code>mysql_server</code>容器更改配置文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysql_server /bin/bash</span><br></pre></td></tr></table></figure>
<p>在数据库配置文件中设置(通常为<code>/etc/my.cnf</code>):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="built_in">log</span>-bin = mysql-bin</span><br><span class="line">sync_binlog = 1</span><br><span class="line">innodb_support_xa = 1</span><br></pre></td></tr></table></figure>
<p>连接到<code>192.168.2.230</code>做同样的操作。</p>
<p>这样两台机器都启用了二进制日志。</p>
<h4 id="2-更改数据库-server-id"><a href="#2-更改数据库-server-id" class="headerlink" title="2.更改数据库 server-id"></a>2.更改数据库 server-id</h4><p>打算将<code>192.168.230</code>作为<strong>从服务器</strong>，<code>192.168.2.5</code>作为<strong>主服务器</strong>，需要将两台机器的数据库<code>server-id</code>更改的不一样。  </p>
<p>在<code>192.168.2.230</code>:<br>进入docker容器:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysql_server /bin/bash</span><br></pre></td></tr></table></figure>
<p>更改数据库配置文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id = 2</span><br></pre></td></tr></table></figure>
<p>并且重命名<code>192.168.2.230</code>中的 <code>auto.cnf</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv auto.cnf auto.cnf.bak</span><br></pre></td></tr></table></figure>
<p>重命名这个文件的原因是这个文件定义了两台服务器的<code>uuid</code>，因为两台服务器的<code>docker</code>镜像是一样的，所以要让<code>mysql</code>重新生成<code>uuid</code>。</p>
<p><code>auto.cnf</code>中的内容一览:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[auto]</span><br><span class="line">server-uuid=9f31bddf-d965-11e6-9c77-0242ac110003</span><br></pre></td></tr></table></figure>
<p>重启<code>mysql</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart</span><br></pre></td></tr></table></figure>
<p>在<code>192.168.2.5</code>:<br>进入docker容器:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysql_server /bin/bash</span><br></pre></td></tr></table></figure>    
<p>更改数据库配置文件:</p>
<pre><code>[mysqld]
server-id = 1
</code></pre><p>重启<code>mysql</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart</span><br></pre></td></tr></table></figure>    
<h4 id="3-配置主从数据库"><a href="#3-配置主从数据库" class="headerlink" title="3.配置主从数据库"></a>3.配置主从数据库</h4><p>在<code>192.168.2.5</code>:<br>进入<code>192.168.2.5</code>的<code>docker</code>容器:<br>创建新用户用于复制功能:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE USER <span class="string">'repl'</span>@<span class="string">'192.168.2.230'</span> IDENTIFIED BY <span class="string">'repl'</span>;</span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO <span class="string">'repl'</span>@<span class="string">'192.168.2.230'</span>;</span><br></pre></td></tr></table></figure>
<p>如果想看一下结果，可以查看<code>mysql</code>用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select user,host from mysql.user;</span><br></pre></td></tr></table></figure>
<p>首先查询主数据库日志文件位置:  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status</span><br><span class="line"></span><br><span class="line">| file             | position |</span><br><span class="line">| mysql-bin.000017 | 120      |</span><br></pre></td></tr></table></figure>
<p>获取到两个重要的信息，二进制日志文件名与执行位置  </p>
<p>在<code>192.168.2.230</code>:<br>进入<code>192.168.2.230</code>的<code>docker</code>容器:<br>配置从服务器:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO</span><br><span class="line">MASTER_HOST =<span class="string">'192.168.2.5'</span>,</span><br><span class="line">MASTER_USER =<span class="string">'repl'</span>,</span><br><span class="line">MASTER_PASSWORD =<span class="string">'repl'</span>,</span><br><span class="line">MASTER_LOG_FILE =<span class="string">'mysql-bin.000017'</span>,</span><br><span class="line">MASTER_LOG_POS =120;</span><br></pre></td></tr></table></figure>
<p>其中<code>MASTER_LOG_FILE</code>与<code>MASTER_LOG_POS</code>要与主数据库中的<code>show master status</code>的结果一致。</p>
<p>开启从数据库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure>
<p>查看是否配置成功:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status;</span><br><span class="line"></span><br><span class="line">| Slave_IO_Running | Slave_SQL_Running | Last_IO_Error | Last_SQL_Error|</span><br><span class="line">| yes              | yes               |               |               |</span><br></pre></td></tr></table></figure>
<p>如果<code>Slave_SQL_Running</code>与<code>Slave_IO_Running</code>其中一个不是<code>yes</code>，就没有配置成功，具体错误可以在<code>Last_IO_Error</code>和<code>Last_SQL_Error</code>中查看。</p>
<p>依据这个原理，可以写一个脚本用户实时的去检查主从数据库是不是出错，如果出错了就发邮件给管理者，这里使用的是<code>python</code>写的脚本。</p>
<p>安装<code>mysql-connector for python</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/Downloads/Connector-Python/mysql-connector-python-2.1.5-1.el6.x86_64.rpm</span><br><span class="line">rpm -i mysql-connector-python-2.1.5-1.el6.x86_64.rpm</span><br></pre></td></tr></table></figure>
<p>安好connector后开始写<code>python</code>脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> mysql.connector</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql</span></span><br><span class="line">HOST = <span class="string">'127.0.0.1'</span></span><br><span class="line">USER = <span class="string">'xxx'</span></span><br><span class="line">PASSWORD = <span class="string">'xxxx'</span></span><br><span class="line">LOG_FILE = <span class="string">'/var/log/mysqlchk.log'</span></span><br><span class="line">TIME_GAP = <span class="number">120</span>  <span class="comment"># interval time gap (unit seconds)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># smtp</span></span><br><span class="line">mailto_list = [<span class="string">"me@qq.com"</span>]</span><br><span class="line">mail_host = <span class="string">"smtp.domain.com"</span></span><br><span class="line">mail_user = <span class="string">"xxx"</span></span><br><span class="line">mail_pass = <span class="string">"xxx"</span></span><br><span class="line">mail_postfix = <span class="string">"domain.com"</span></span><br><span class="line">mail_nick_name = <span class="string">'MySQL CHK'</span></span><br><span class="line">mail_subject = <span class="string">'[ERROR] MySQL Replication Error'</span></span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line">logger.setLevel(logging.INFO)</span><br><span class="line"><span class="comment"># create a file handler</span></span><br><span class="line">handler = logging.FileHandler(LOG_FILE)</span><br><span class="line">handler.setLevel(logging.INFO)</span><br><span class="line"><span class="comment"># create a logging format</span></span><br><span class="line">formatter = logging.Formatter(<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line">handler.setFormatter(formatter)</span><br><span class="line"><span class="comment"># add the handlers to the logger</span></span><br><span class="line">logger.addHandler(handler)</span><br><span class="line"></span><br><span class="line">logger.info(<span class="string">'program start'</span>)</span><br><span class="line">cnx = mysql.connector.connect(user=USER, password=PASSWORD, host=HOST)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_mail</span><span class="params">(to_list, sub, content)</span>:</span></span><br><span class="line">    me = mail_nick_name + <span class="string">"&lt;"</span> + mail_user + <span class="string">"@"</span> + mail_postfix + <span class="string">"&gt;"</span></span><br><span class="line">    msg = MIMEText(content, _subtype=<span class="string">'plain'</span>, _charset=<span class="string">'gb2312'</span>)</span><br><span class="line">    msg[<span class="string">'Subject'</span>] = sub</span><br><span class="line">    msg[<span class="string">'From'</span>] = me</span><br><span class="line">    msg[<span class="string">'To'</span>] = <span class="string">";"</span>.join(to_list)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server = smtplib.SMTP()</span><br><span class="line">        server.connect(mail_host)</span><br><span class="line">        server.login(mail_user, mail_pass)</span><br><span class="line">        server.sendmail(me, to_list, msg.as_string())</span><br><span class="line">        server.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">print</span> str(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">()</span>:</span></span><br><span class="line">        logger.info(<span class="string">'start check slave status..'</span>)</span><br><span class="line">        cur = cnx.cursor()</span><br><span class="line">        query = (<span class="string">"show slave status"</span>)</span><br><span class="line">        cur.execute(query)</span><br><span class="line">        res = cur.fetchone()</span><br><span class="line">        (slave_io_running, slave_sql_running, last_io_error) = (res[<span class="number">10</span>], res[<span class="number">11</span>], res[<span class="number">35</span>])</span><br><span class="line">        <span class="keyword">if</span> slave_io_running != <span class="string">'yes'</span> <span class="keyword">and</span> slave_sql_running != <span class="string">'yes'</span>:</span><br><span class="line">            error = <span class="string">'[ERROR]Slave Error:&#123;0&#125;'</span>.format(last_io_error);</span><br><span class="line">            logger.error(error)</span><br><span class="line">            send_mail(mailto_list, mail_subject, error)</span><br><span class="line">        cur.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        check()</span><br><span class="line">        time.sleep(TIME_GAP)</span><br><span class="line"><span class="keyword">except</span> Exception, e:</span><br><span class="line">    logger.error(str(e))</span><br><span class="line">    send_mail(mailto_list, mail_subject, str(e))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    cnx.close</span><br><span class="line">    logger.info(<span class="string">'program terminate'</span>)</span><br></pre></td></tr></table></figure>
<p>这个脚本的用处就是每两分钟去检测主从服务器连接是否正常，如果不正常将会发送错误消息给管理员。<br>到这里主从数据库配置就完成了，可以通过连接<code>192.168.2.5</code>，执行数据库创建操作，然后再到<code>192.168.2.230</code>看新的数据库是否创建来试验<code>mysql</code>的复制(replication)功能。</p>
<h4 id="4-自动创建快照"><a href="#4-自动创建快照" class="headerlink" title="4.自动创建快照"></a>4.自动创建快照</h4><p>这一步开始在<strong>从数据库</strong>所在服务器<code>192.168.2.230</code>的数据库文件进行快照的操作，其实这一步之前，将<code>mysql</code>的数据库文件路径<code>/mnt1/data/mysql</code>挂载到了一个专用的LVM逻辑卷。<br>在<code>192.168.2.230</code>执行（不进入<code>docker</code>):<br>查看分区:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@syk230# fdisk -l</span><br><span class="line">    Device     Boot   Start        End    Sectors  Size Id Type</span><br><span class="line">/dev/sda1  *       2048     999423     997376  487M 83 Linux</span><br><span class="line">/dev/sda2       1001470 3907028991 3906027522  1.8T  5 Extended</span><br><span class="line">/dev/sda5       1001472 3907028991 3906027520  1.8T 8e Linux LVM</span><br></pre></td></tr></table></figure>
<p>查看卷组:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@syk230# vgdisplay</span><br><span class="line">      --- Volume group ---</span><br><span class="line">  VG Name               syk230-vg</span><br><span class="line">  System ID</span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        1</span><br><span class="line">  Metadata Sequence No  52</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                4</span><br><span class="line">  Open LV               3</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                1</span><br><span class="line">  Act PV                1</span><br><span class="line">  VG Size               1.82 TiB</span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line">  Total PE              476809</span><br><span class="line">  Alloc PE / Size       11076 / 43.27 GiB</span><br><span class="line">  Free  PE / Size       465733 / 1.78 TiB</span><br><span class="line">  VG UUID               brRcUd-vF1G-rWjH-EJW5-jiWG-fsrN-j2RtlN</span><br></pre></td></tr></table></figure>
<p>在<code>syk230-vg</code>卷组上创建一个名为<code>mysql</code>的逻辑卷，大小为3G:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -L 3G -n mysql syk230-vg</span><br></pre></td></tr></table></figure>
<p>查看逻辑卷:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@syk230# lvdisplay</span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/syk230-vg/mysql</span><br><span class="line">  LV Name                mysql</span><br><span class="line">  VG Name                syk230-vg</span><br><span class="line">  LV UUID                09gVIy-r0vY-rGrX-G6sf-EDm4-483o-ZDaO66</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time syk230, 2017-01-12 12:16:22 +0800</span><br><span class="line">  LV snapshot status     source of</span><br><span class="line">                         mysqlsnap [active]</span><br><span class="line">  LV Status              available</span><br><span class="line">  # open                 1</span><br><span class="line">  LV Size                3.00 GiB</span><br><span class="line">  Current LE             768</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     256</span><br><span class="line">  Block device           252:2</span><br></pre></td></tr></table></figure>
<p>格式化分区(ext4):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.ext4 /dev/syk230-vg/mysql</span><br></pre></td></tr></table></figure>
<p>挂载分区:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/fstab</span><br></pre></td></tr></table></figure>
<p>添加内容:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/mapper/syk230--vg-mysql /mnt1/data/mysql ext4 defaults 0 2</span><br></pre></td></tr></table></figure>
<p>至此，为存储mysql数据逻辑卷创建好了。<br><strong>编写自动创建备份的脚本</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">tmppath=/mnt1/data/mysqlbak1</span><br><span class="line">bakpath=/mnt1/data/mysqlbak</span><br><span class="line">filename=`date +%Y%m%d.tar.gz`</span><br><span class="line">binpos=/tmp/binpos.log</span><br><span class="line"></span><br><span class="line">mysql -h 172.17.0.2 -u zyl --password=zyl -e <span class="string">"flush tables with read lock"</span></span><br><span class="line">mysql -h 172.17.0.2 -u zyl --password=zyl -e <span class="string">"show master status\G"</span> | grep <span class="string">'File\|Position'</span> | xargs &gt; <span class="variable">$binpos</span></span><br><span class="line">mysql -h 172.17.0.2 -u zyl --password=zyl -e <span class="string">"show slave status\G"</span> | grep <span class="string">'Relay_Log_File\|Relay_Log_Pos'</span> | xargs &gt;&gt; <span class="variable">$binpos</span></span><br><span class="line">lvcreate -s -n mysqlsnap1 -L 5G /dev/syk230-vg/mysql</span><br><span class="line">mysql -h 172.17.0.2 -u zyl --password=zyl -e <span class="string">"unlock tables"</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$tmppath</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        mkdir <span class="variable">$tmppath</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$bakpath</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        mkdir <span class="variable">$bakpath</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">mount /dev/syk230-vg/mysqlsnap1 <span class="variable">$tmppath</span></span><br><span class="line">mv <span class="variable">$binpos</span> <span class="variable">$tmppath</span></span><br><span class="line">tar -czf <span class="string">"<span class="variable">$bakpath</span>/<span class="variable">$filename</span>"</span> -C <span class="variable">$tmppath</span> .</span><br><span class="line">umount <span class="variable">$tmppath</span></span><br><span class="line">rmdir <span class="variable">$tmppath</span></span><br><span class="line">lvremove -f /dev/syk230-vg/mysqlsnap1</span><br></pre></td></tr></table></figure>
<p>其中<code>172.17.0.2</code>是<code>docker</code>中<code>mysql_server</code>容器本机内网ip。可以通过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect bridge</span><br></pre></td></tr></table></figure>
<p>查询。<br>将执行脚本计划添加到<code>crontab</code>中:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure>
<p>添加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 * * * /bin/bash /mnt1/data/mysqlbak.sh</span><br></pre></td></tr></table></figure>
<p>这样每天凌晨备份一次数据库，并且不需要停止数据库。</p>
<p><strong>删除30天之前的备份</strong>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find /mnt1/data/mysqlbak -mtime +30 -delete &gt; /mnt1/data/mysqldel.sh</span><br><span class="line">chmod 755 /mnt1/data/mysqldel.sh</span><br></pre></td></tr></table></figure>
<p>crontab 添加内容:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 * * * /bin/bash /mnt1/data/mysqldel.sh</span><br></pre></td></tr></table></figure>
<h2 id="4-小结"><a href="#4-小结" class="headerlink" title="4.小结"></a>4.小结</h2><p>总的说来，配置MySQL的复制功能比配置LVM简单太多,主要是因为是否能正确的使用LVM快照功能跟硬盘配置选项有直接的关系，主要有以下几点需要注意到： </p>
<ul>
<li>安装系统的时候要选LVM管理的磁盘</li>
<li>安装系统分区的时候<strong>一定不要将系统分区占满整个磁盘</strong>，否则LVM无法分配新的空间来创建逻辑卷，且系统分区不可删除和缩小(否则需要用<code>cd-live</code>或者<code>usb-live</code>)</li>
<li>添加新硬盘的时候用<code>pvcreate</code>,<code>vgcreate</code>分别来创建物理卷和卷组</li>
<li>如果安装系统时没有选择LVM，用<code>fdisk</code>创建新的分区并且更改磁盘类型为<code>8e</code>(LVM类型代码)</li>
</ul>
<p>结合MySQL的复制功能和LVM的快照功能，既能保证数据的实时同步，又能防止程序或数据库管理员的误操作。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>《高性能MySQL》</p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>作者: </span>
      <span>allyn</span>
    </p>
    <p class="copyright-item">
      <span>来源: </span>
      <a href="http://www.yilnz.com">http://www.yilnz.com</a>
    </p>
    <p class="copyright-item">
      <span>链接: </span>
      <a href="http://www.yilnz.com/mysql-backup/">http://www.yilnz.com/mysql-backup/</a>
    </p>

    <p class="copyright-item lincese">
      
      本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
    </p>
  </div>



      
      

      
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style" style="height:15px;margin-top:10px">
	<span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_tools_1"></a>
	<a class="jiathis_button_tools_2"></a>
	<a class="jiathis_button_tools_3"></a>
	<a class="jiathis_button_tools_4"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="https://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->


    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/mysql/">mysql</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/mysql-restore/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">MySQL 数据库基于LVM快照恢复</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/cssmodel/">
        <span class="next-text nav-default">CSS 盒子模型</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:me10zyl@qq.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
<!--
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>
-->
  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2019

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">allyn</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://www.yilnz.com/mysql-backup/';
        this.page.identifier = 'mysql-backup/';
        this.page.title = 'MySQL 数据库基于LVM快照热备份';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//allyn.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  




    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  <script type="text/html" id="search-result">
    <article class="post">
      <header class="post-header">
        <h1 class="post-title">
          <a href="$url$" class="post-link">
            $title$
          </a>
        </h1>
      </header>
      <div class="post-content">
        $content$
        <div class="read-more">
          <a href="$url$" class="read-more-link">
            阅读更多
          </a>
        </div>
      </div>
    </article>
  </script>
  <script type="text/html" id="no-search-result">
    <div class="no-result">
      <h2>No result found!</h2>
    </div>
  </script>
  <script type="text/javascript" src="/js/src/search.js?v=2.4.x"></script>

  </body>
</html>
